name: ğŸš€ Auto Deploy to Sakura Internet (Optimized)

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
  workflow_dispatch:
    inputs:
      full_deploy:
        description: 'ãƒ•ãƒ«ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆä¾å­˜é–¢ä¿‚ã‚‚æ›´æ–°ï¼‰'
        required: false
        default: 'no'
        type: choice
        options:
          - yes
          - no

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3
    
    - name: ğŸ”§ Install deployment tools
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y sshpass rsync
    
    - name: ğŸš€ Deploy to Sakura Internet
      env:
        REMOTE_HOST: mokumoku.sakura.ne.jp
        REMOTE_USER: mokumoku
        REMOTE_PASSWORD: ${{ secrets.SAKURA_PASSWORD }}
        REMOTE_PATH: /home/mokumoku/www/tags
      run: |
        echo "ğŸ” SSHæ¥ç¶šã‚’ãƒ†ã‚¹ãƒˆä¸­..."
        sshpass -p "$REMOTE_PASSWORD" ssh -o StrictHostKeyChecking=no -p 22 "$REMOTE_USER@$REMOTE_HOST" "echo 'âœ… SSHæ¥ç¶šæˆåŠŸ'"
        
        echo "ğŸ“ ãƒªãƒ¢ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æº–å‚™ä¸­..."
        sshpass -p "$REMOTE_PASSWORD" ssh -p 22 "$REMOTE_USER@$REMOTE_HOST" "
          mkdir -p $REMOTE_PATH/logs
        "
        
        # APIã‚µãƒ¼ãƒãƒ¼ãŒå‹•ã„ã¦ã„ã‚Œã°åœæ­¢
        echo "ğŸ›‘ æ—¢å­˜APIã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢ä¸­..."
        sshpass -p "$REMOTE_PASSWORD" ssh -p 22 "$REMOTE_USER@$REMOTE_HOST" "
          cd $REMOTE_PATH
          if [ -f 'api_server.pid' ]; then
            PID=\$(cat api_server.pid)
            if ps -p \$PID > /dev/null 2>&1; then
              kill \$PID || true
              sleep 2
            fi
          fi
          # å¤ã„ãƒ—ãƒ­ã‚»ã‚¹ã‚‚åœæ­¢
          pkill -f 'api_server' || true
        "
        
        echo "ğŸ“¦ å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’åŒæœŸä¸­..."
        # rsyncã®å‰ã«å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
        if [ ! -f "index.html" ] && [ -f "index_final.html" ]; then
          cp index_final.html index.html
          echo "ğŸ“ index.htmlã‚’ä½œæˆã—ã¾ã—ãŸ"
        fi
        
        sshpass -p "$REMOTE_PASSWORD" rsync -avz \
          --exclude=.git \
          --exclude=.env \
          --exclude=.env.template \
          --exclude=__pycache__ \
          --exclude=*.pyc \
          --exclude=venv \
          --exclude=.DS_Store \
          --exclude=logs \
          --exclude=.github \
          --exclude='*.bak' \
          --exclude=backups \
          --exclude=service.pid \
          --exclude=api_server.pid \
          -e "ssh -p 22 -o StrictHostKeyChecking=no" \
          ./ "$REMOTE_USER@$REMOTE_HOST:$REMOTE_PATH/"
        
        # requirements.txtãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã€ã¾ãŸã¯æ˜ç¤ºçš„ã«æŒ‡å®šã•ã‚ŒãŸå ´åˆã®ã¿ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        if [ "${{ github.event.inputs.full_deploy }}" = "yes" ] || git diff --name-only HEAD^ HEAD | grep -q "requirements.txt"; then
          echo "ğŸ“š ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
          sshpass -p "$REMOTE_PASSWORD" ssh -p 22 "$REMOTE_USER@$REMOTE_HOST" "
            cd $REMOTE_PATH
            
            # ä»®æƒ³ç’°å¢ƒã®ç¢ºèª
            if [ ! -d 'venv' ]; then
              python3 -m venv venv
              echo 'âœ… ä»®æƒ³ç’°å¢ƒã‚’ä½œæˆã—ã¾ã—ãŸ'
            fi
            
            # ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
            . venv/bin/activate
            python3 -m pip install --upgrade pip
            
            # åŸºæœ¬ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã¿ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆé«˜é€ŸåŒ–ï¼‰
            pip install python-dotenv requests
            echo 'âœ… åŸºæœ¬ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã—ãŸ'
          "
        else
          echo "â„¹ï¸ ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆå¤‰æ›´ãªã—ï¼‰"
        fi
        
        echo "âš™ï¸ å®Ÿè¡Œæ¨©é™ã‚’è¨­å®šä¸­..."
        sshpass -p "$REMOTE_PASSWORD" ssh -p 22 "$REMOTE_USER@$REMOTE_HOST" "
          cd $REMOTE_PATH
          chmod +x *.sh 2>/dev/null || true
          chmod +x *.py 2>/dev/null || true
        "
        
        echo "ğŸŒ ãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°ã‚’å®Ÿè¡Œä¸­..."
        sshpass -p "$REMOTE_PASSWORD" ssh -p 22 "$REMOTE_USER@$REMOTE_HOST" "
          cd $REMOTE_PATH
          
          # é‡è¦ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèªã¨æ¨©é™è¨­å®š
          if [ ! -f 'index.html' ]; then
            echo 'âš ï¸ index.htmlãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚ä½œæˆã—ã¾ã™...'
            if [ -f 'index_final.html' ]; then
              cp index_final.html index.html
            else
              echo 'ã‚¨ãƒ©ãƒ¼: index.htmlã‚‚index_final.htmlã‚‚å­˜åœ¨ã—ã¾ã›ã‚“'
              exit 1
            fi
          fi
          
          # ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™ã®ä¿®æ­£ï¼ˆForbiddenå¯¾ç­–ï¼‰
          chmod 644 *.html *.css *.js 2>/dev/null || true
          chmod 755 *.php 2>/dev/null || true
          chmod 755 . 2>/dev/null || true
          
          echo 'âœ… ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™ã‚’è¨­å®šã—ã¾ã—ãŸ'
          
          # è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ç¢ºèªï¼ˆé‡è¦ï¼‰
          cd /home/mokumoku/www
          chmod 755 tags
          cd $REMOTE_PATH
          
          # .htaccessãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆNginxã§ã¯ä¸è¦ï¼‰
          if [ -f '/home/mokumoku/www/.htaccess' ]; then
            rm -f /home/mokumoku/www/.htaccess
            echo 'ğŸ§¹ ä¸è¦ãª.htaccessã‚’å‰Šé™¤ã—ã¾ã—ãŸ'
          fi
          
          # APIã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•
          if [ -f 'api_server_v2.py' ]; then
            echo 'ğŸš€ API Server v2ã‚’èµ·å‹•ä¸­...'
            nohup python3 api_server_v2.py > logs/api_server.log 2>&1 &
            echo \$! > api_server.pid
            sleep 3
            
            # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
            if curl -s http://localhost:8080/api/status > /dev/null; then
              echo 'âœ… API Server v2ãŒæ­£å¸¸ã«èµ·å‹•ã—ã¾ã—ãŸ'
            else
              echo 'âš ï¸ API Serverã®èµ·å‹•ã«å¤±æ•—ã—ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™'
            fi
          elif [ -f 'api_server.py' ]; then
            echo 'ğŸš€ API Serverã‚’èµ·å‹•ä¸­...'
            nohup python3 api_server.py > logs/api_server.log 2>&1 &
            echo \$! > api_server.pid
          fi
        "
        
        echo ""
        echo "ğŸ‰ ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†!"
        echo "=================================="
        echo "ğŸŒ ãƒ¡ã‚¤ãƒ³URL: https://mokumoku.sakura.ne.jp/tags/"
        echo "ğŸ“± ãƒ‡ãƒ¢ç‰ˆ: https://mokumoku.sakura.ne.jp/tags/webapp.html"
        echo "ğŸ”— APIç‰ˆ: https://mokumoku.sakura.ne.jp/tags/webapp_api.html"
        echo ""
        echo "ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚é–“: $(date +'%Y-%m-%d %H:%M:%S')"
    
    - name: ğŸ“Š Deployment Summary
      if: always()
      run: |
        echo "## ğŸ“Š ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚µãƒãƒªãƒ¼"
        echo "- **ãƒ–ãƒ©ãƒ³ãƒ**: ${{ github.ref_name }}"
        echo "- **ã‚³ãƒŸãƒƒãƒˆ**: ${{ github.sha }}"
        echo "- **å®Ÿè¡Œè€…**: ${{ github.actor }}"
        echo "- **æ™‚åˆ»**: $(date +'%Y-%m-%d %H:%M:%S')"
        echo "- **ãƒ•ãƒ«ãƒ‡ãƒ—ãƒ­ã‚¤**: ${{ github.event.inputs.full_deploy || 'no' }}"