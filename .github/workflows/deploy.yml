name: ğŸš€ Auto Deploy to Sakura Internet

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
  workflow_dispatch:
    inputs:
      restart_service:
        description: 'ã‚µãƒ¼ãƒ“ã‚¹ã‚’å†èµ·å‹•ã—ã¾ã™ã‹ï¼Ÿ'
        required: true
        default: 'yes'
        type: choice
        options:
          - yes
          - no

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'
    
    - name: ğŸ§ª Run tests
      run: |
        python -m pip install --upgrade pip
        pip install pytest
        python -m pytest tests/ -v || echo "âš ï¸ ãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ"
    
    - name: ğŸ”§ Install deployment tools
      run: |
        sudo apt-get update
        sudo apt-get install -y sshpass rsync
    
    - name: ğŸš€ Deploy to Sakura Internet
      env:
        REMOTE_HOST: mokumoku.sakura.ne.jp
        REMOTE_USER: mokumoku
        REMOTE_PASSWORD: ${{ secrets.SAKURA_PASSWORD }}
        REMOTE_PATH: /home/mokumoku/www/tags
      run: |
        echo "ğŸ” SSHæ¥ç¶šã‚’ãƒ†ã‚¹ãƒˆä¸­..."
        sshpass -p "$REMOTE_PASSWORD" ssh -o StrictHostKeyChecking=no -p 22 "$REMOTE_USER@$REMOTE_HOST" "echo 'âœ… SSHæ¥ç¶šæˆåŠŸ'"
        
        echo "ğŸ“ ãƒªãƒ¢ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æº–å‚™ä¸­..."
        sshpass -p "$REMOTE_PASSWORD" ssh -p 22 "$REMOTE_USER@$REMOTE_HOST" "
          mkdir -p $REMOTE_PATH
          mkdir -p $REMOTE_PATH/logs
          mkdir -p /home/mokumoku/backups
        "
        
        echo "ğŸ’¾ æ—¢å­˜ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸­..."
        TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
        sshpass -p "$REMOTE_PASSWORD" ssh -p 22 "$REMOTE_USER@$REMOTE_HOST" "
          if [ -d '$REMOTE_PATH' ] && [ \"\$(ls -A $REMOTE_PATH 2>/dev/null)\" ]; then
            # ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢
            if [ -f '$REMOTE_PATH/service.pid' ]; then
              echo 'ğŸ›‘ æ—¢å­˜ã‚µãƒ¼ãƒ“ã‚¹ã‚’åœæ­¢ä¸­...'
              cd $REMOTE_PATH && ./stop_tag_generator.sh || true
            fi
            
            # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ
            cp -r $REMOTE_PATH /home/mokumoku/backups/tag_generator_$TIMESTAMP
            echo 'âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ: /home/mokumoku/backups/tag_generator_$TIMESTAMP'
          fi
        "
        
        echo "ğŸ“¦ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åŒæœŸä¸­..."
        sshpass -p "$REMOTE_PASSWORD" rsync -avz --delete \
          --exclude=.git \
          --exclude=.env \
          --exclude=__pycache__ \
          --exclude=*.pyc \
          --exclude=venv \
          --exclude=.DS_Store \
          --exclude=logs/*.log \
          --exclude=.github \
          --exclude='*.bak' \
          -e "ssh -p 22 -o StrictHostKeyChecking=no" \
          ./ "$REMOTE_USER@$REMOTE_HOST:$REMOTE_PATH/"
        
        echo "ğŸ“š ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
        sshpass -p "$REMOTE_PASSWORD" ssh -p 22 "$REMOTE_USER@$REMOTE_HOST" "
          cd $REMOTE_PATH
          
          # ä»®æƒ³ç’°å¢ƒã®ä½œæˆãƒ»ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆ
          if [ ! -d 'venv' ]; then
            python3 -m venv venv
            echo 'âœ… ä»®æƒ³ç’°å¢ƒã‚’ä½œæˆã—ã¾ã—ãŸ'
          fi
          
          # ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰
          . venv/bin/activate
          python3 -m pip install --upgrade pip
          
          # å¤ã„Pythonå¯¾å¿œã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          echo 'ğŸ“¦ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­...'
          pip install streamlit==1.28.0 || pip install streamlit==1.25.0
          pip install pandas==1.5.3 || pip install pandas==1.3.5
          pip install numpy==1.21.6 || pip install numpy==1.19.5
          pip install scikit-learn==1.1.3 || pip install scikit-learn==1.0.2
          pip install google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client
          pip install python-dotenv requests
          pip install openai anthropic google-generativeai || echo 'âš ï¸ AI APIãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯å¾Œã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«'
        "
        
        echo "âš™ï¸ ã‚µãƒ¼ãƒ“ã‚¹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è¨­å®šä¸­..."
        sshpass -p "$REMOTE_PASSWORD" ssh -p 22 "$REMOTE_USER@$REMOTE_HOST" "
          cd $REMOTE_PATH
          chmod +x *.sh 2>/dev/null || true
          chmod +x *.py 2>/dev/null || true
          
          # shebangä¿®æ­£ï¼ˆã•ãã‚‰ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆå¯¾å¿œï¼‰
          sed -i 's|#!/bin/bash|#!/bin/sh|g' *.sh 2>/dev/null || true
        "
        
        echo "ğŸ” .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªä¸­..."
        sshpass -p "$REMOTE_PASSWORD" ssh -p 22 "$REMOTE_USER@$REMOTE_HOST" "
          cd $REMOTE_PATH
          if [ -f '.env' ]; then
            echo 'âœ… .envãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã™ (APIã‚­ãƒ¼è¨­å®šæ¸ˆã¿)'
          else
            if [ -f '.env.template' ]; then
              echo 'âš ï¸ .envãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰ä½œæˆã—ã¾ã™...'
              cp .env.template .env
              echo 'ğŸ“ .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¦APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„'
            fi
          fi
        "
        
        echo "ğŸŒ Webè¨­å®šã‚’ç¢ºèªä¸­..."
        sshpass -p "$REMOTE_PASSWORD" ssh -p 22 "$REMOTE_USER@$REMOTE_HOST" "
          cd $REMOTE_PATH
          
          # Webè¨­å®šã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œï¼ˆåˆå›ã®ã¿ï¼‰
          if [ ! -f '/home/mokumoku/www/.htaccess' ]; then
            echo 'ğŸ”§ Webè¨­å®šã‚’å®Ÿè¡Œä¸­...'
            sh web_setup.sh || echo 'âš ï¸ Webè¨­å®šã¯æ‰‹å‹•ã§å®Ÿè¡Œã—ã¦ãã ã•ã„'
          else
            echo 'âœ… Webè¨­å®šã¯å®Œäº†æ¸ˆã¿'
          fi
        "
        
        # ã‚µãƒ¼ãƒ“ã‚¹å†èµ·å‹•ï¼ˆworkflow_dispatchã®å ´åˆã®ã¿åˆ¶å¾¡å¯èƒ½ï¼‰
        if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.restart_service }}" = "yes" ]; then
          echo "ğŸ”„ ã‚µãƒ¼ãƒ“ã‚¹ã‚’å†èµ·å‹•ä¸­..."
          sshpass -p "$REMOTE_PASSWORD" ssh -p 22 "$REMOTE_USER@$REMOTE_HOST" "
            cd $REMOTE_PATH
            
            # æ—¢å­˜ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢
            if [ -f 'service.pid' ]; then
              ./stop_tag_generator.sh || true
              sleep 2
            fi
            
            # ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•
            ./start_tag_generator_web.sh || ./start_tag_generator.sh
            
            echo 'âœ… ã‚µãƒ¼ãƒ“ã‚¹ã‚’å†èµ·å‹•ã—ã¾ã—ãŸ'
          "
        else
          echo "â„¹ï¸ ã‚µãƒ¼ãƒ“ã‚¹ã®è‡ªå‹•å†èµ·å‹•ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸ"
          echo "   æ‰‹å‹•ã§å†èµ·å‹•: ssh $REMOTE_USER@$REMOTE_HOST 'cd $REMOTE_PATH && ./start_tag_generator_web.sh'"
        fi
        
        echo ""
        echo "ğŸ‰ ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†!"
        echo "=================================="
        echo "ğŸŒ ãƒ¡ã‚¤ãƒ³URL: http://mokumoku.sakura.ne.jp/tags/"
        echo "ğŸ”— ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹: http://mokumoku.sakura.ne.jp:8501"
        echo ""
        echo "ğŸ“‹ æ¬¡ã®æ‰‹é †:"
        echo "1. ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ³ç¢ºèª: ssh $REMOTE_USER@$REMOTE_HOST 'cd $REMOTE_PATH && ./status_tag_generator.sh'"
        echo "2. ãƒ­ã‚°ç¢ºèª: ssh $REMOTE_USER@$REMOTE_HOST 'tail -f $REMOTE_PATH/logs/service.log'"
        echo "3. ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•: ssh $REMOTE_USER@$REMOTE_HOST 'cd $REMOTE_PATH && ./start_tag_generator_web.sh'"
    
    - name: ğŸ“Š Deployment Summary
      if: always()
      run: |
        echo "## ğŸ“Š ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚µãƒãƒªãƒ¼"
        echo "- **ãƒ–ãƒ©ãƒ³ãƒ**: ${{ github.ref_name }}"
        echo "- **ã‚³ãƒŸãƒƒãƒˆ**: ${{ github.sha }}"
        echo "- **å®Ÿè¡Œè€…**: ${{ github.actor }}"
        echo "- **æ™‚åˆ»**: $(date +'%Y-%m-%d %H:%M:%S')"