#!/usr/bin/env python3
"""
æ”¹è‰¯ç‰ˆStage2ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å‹•ä½œãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
"""

import json
import sys
import os
from typing import List, Dict, Any

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ãƒ‘ã‚¹ã«è¿½åŠ 
sys.path.append(os.path.join(os.path.dirname(os.path.abspath(__file__)), '..', '..'))

from staged_tag_processor import StagedTagProcessor
from ai_api_handler import AIAPIHandler

def create_test_video_data() -> List[Dict[str, Any]]:
    """ãƒ†ã‚¹ãƒˆç”¨ã®å‹•ç”»ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ"""
    return [
        {
            'title': 'åŠ¹æœçš„ãªãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³æŠ€æ³•',
            'skill': 'ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³',
            'description': 'è´è¡†ã‚’æƒ¹ãã¤ã‘ã‚‹ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³æŠ€æ³•ã‚’å­¦ã¶',
            'summary': 'ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®åŸºæœ¬æ§‹æˆã¨åŠ¹æœçš„ãªä¼é”æ–¹æ³•ã«ã¤ã„ã¦è§£èª¬',
            'transcript': 'ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã«ãŠã„ã¦æœ€ã‚‚é‡è¦ãªã®ã¯ã€è´è¡†ã¨ã®ä¿¡é ¼é–¢ä¿‚ã®æ§‹ç¯‰ã§ã™ã€‚ã¾ãšã€ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ã§æ³¨æ„ã‚’æƒ¹ãã¤ã‘ã€æ˜ç¢ºãªæ§‹æˆã‚’ç¤ºã™ã“ã¨ãŒå¤§åˆ‡ã§ã™ã€‚ãƒœãƒ‡ã‚£ãƒ‘ãƒ¼ãƒˆã§ã¯è«–ç†çš„ãªæµã‚Œã‚’ä¿ã¡ã€å…·ä½“çš„ãªäº‹ä¾‹ã‚„ãƒ‡ãƒ¼ã‚¿ã‚’æ´»ç”¨ã—ã¦èª¬å¾—åŠ›ã‚’é«˜ã‚ã¾ã™ã€‚è¦–è¦šçš„è³‡æ–™ã¯è£œåŠ©ã¨ã—ã¦ä½¿ç”¨ã—ã€ã‚¢ã‚¤ã‚³ãƒ³ã‚¿ã‚¯ãƒˆã¨èº«æŒ¯ã‚Šæ‰‹æŒ¯ã‚Šã§è´è¡†ã¨ç¹‹ãŒã‚Šã¾ã™ã€‚è³ªç–‘å¿œç­”ã§ã¯å†·é™ã«å¯¾å¿œã—ã€åˆ†ã‹ã‚‰ãªã„å ´åˆã¯æ­£ç›´ã«ä¼ãˆã‚‹ã“ã¨ã‚‚é‡è¦ã§ã™ã€‚'
        },
        {
            'title': 'ãƒ‡ã‚¸ã‚¿ãƒ«ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°åŸºç¤',
            'skill': 'ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°',
            'description': 'SEOã¨SNSæ´»ç”¨ã«ã‚ˆã‚‹åŠ¹æœçš„ãªãƒ‡ã‚¸ã‚¿ãƒ«ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æˆ¦ç•¥',
            'summary': 'ãƒ‡ã‚¸ã‚¿ãƒ«æ™‚ä»£ã®ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æ‰‹æ³•ã¨å®Ÿè·µæ–¹æ³•ã‚’å­¦ç¿’',
            'transcript': 'ãƒ‡ã‚¸ã‚¿ãƒ«ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ã®æ ¸å¿ƒã¯é¡§å®¢ã¨ã®æ¥ç‚¹ã‚’æœ€å¤§åŒ–ã™ã‚‹ã“ã¨ã§ã™ã€‚Google Analytics ã‚’ä½¿ç”¨ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡Œå‹•ã‚’åˆ†æã—ã€SEOå¯¾ç­–ã§ã‚ªãƒ¼ã‚¬ãƒ‹ãƒƒã‚¯æ¤œç´¢ã‹ã‚‰ã®æµå…¥ã‚’å¢—ã‚„ã—ã¾ã™ã€‚Facebook åºƒå‘Šã‚„Instagram åºƒå‘Šã‚’æ´»ç”¨ã—ãŸãƒšã‚¤ãƒ‰ãƒ¡ãƒ‡ã‚£ã‚¢æˆ¦ç•¥ã‚‚é‡è¦ã§ã™ã€‚ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡ã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã«A/Bãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½ã—ã€LTVï¼ˆé¡§å®¢ç”Ÿæ¶¯ä¾¡å€¤ï¼‰ã‚’æœ€å¤§åŒ–ã™ã‚‹ãƒªãƒ†ãƒ³ã‚·ãƒ§ãƒ³æ–½ç­–ã‚’å±•é–‹ã—ã¾ã™ã€‚ROIè¨ˆç®—ã«ã‚ˆã‚‹åŠ¹æœæ¸¬å®šã‚‚æ¬ ã‹ã›ã¾ã›ã‚“ã€‚'
        },
        {
            'title': 'Excelé–¢æ•°ã¨ãƒ”ãƒœãƒƒãƒˆãƒ†ãƒ¼ãƒ–ãƒ«æ´»ç”¨è¡“',
            'skill': 'ãƒ‡ãƒ¼ã‚¿åˆ†æ',
            'description': 'VLOOKUPã€SUMIFSç­‰ã®é«˜åº¦ãªExcelé–¢æ•°ã¨ãƒ”ãƒœãƒƒãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã®å®Ÿè·µçš„æ´»ç”¨æ³•',
            'summary': 'æ¥­å‹™åŠ¹ç‡åŒ–ã®ãŸã‚ã®Excelé–¢æ•°ã¨ãƒ”ãƒœãƒƒãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒã‚¹ã‚¿ãƒ¼',
            'transcript': 'Excelã®é–¢æ•°ã‚’ä½¿ã„ã“ãªã™ã“ã¨ã§æ¥­å‹™åŠ¹ç‡ãŒå¤§å¹…ã«å‘ä¸Šã—ã¾ã™ã€‚VLOOKUPé–¢æ•°ã¯åˆ¥ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢ã™ã‚‹éš›ã«ä½¿ç”¨ã—ã€SUMIFSé–¢æ•°ã¯è¤‡æ•°æ¡ä»¶ã§ã®é›†è¨ˆã«æ´»ç”¨ã—ã¾ã™ã€‚INDEXé–¢æ•°ã¨MATCHé–¢æ•°ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€ã‚ˆã‚ŠæŸ”è»Ÿãªæ¤œç´¢ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚ãƒ”ãƒœãƒƒãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã¯å¤§é‡ãƒ‡ãƒ¼ã‚¿ã®é›†è¨ˆã¨åˆ†æã«å¨åŠ›ã‚’ç™ºæ®ã—ã€ã‚¹ãƒ©ã‚¤ã‚µãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§å‹•çš„ãªãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãŒå®Ÿç¾ã§ãã¾ã™ã€‚Power Query ã‚’ä½¿ç”¨ã™ã‚Œã°å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿ã¨ã®é€£æºã‚‚å¯èƒ½ã§ã™ã€‚'
        },
        {
            'title': 'Salesforce CRMå°å…¥ã¨é‹ç”¨æœ€é©åŒ–',
            'skill': 'CRMç®¡ç†',
            'description': 'Salesforce ã®åŸºæœ¬è¨­å®šã‹ã‚‰é«˜åº¦ãªã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã¾ã§ã®åŒ…æ‹¬çš„å°å…¥ã‚¬ã‚¤ãƒ‰',
            'summary': 'Salesforce CRMã‚·ã‚¹ãƒ†ãƒ ã®åŠ¹æœçš„ãªå°å…¥ã¨é‹ç”¨æ–¹æ³•ã‚’ç¿’å¾—',
            'transcript': 'Salesforce CRMã®å°å…¥ã§ã¯ã€ã¾ãšçµ„ç¹”ã®å–¶æ¥­ãƒ—ãƒ­ã‚»ã‚¹ã‚’æ•´ç†ã™ã‚‹ã“ã¨ã‹ã‚‰å§‹ã‚ã¾ã™ã€‚ãƒªãƒ¼ãƒ‰ã®å–ã‚Šè¾¼ã¿ã‹ã‚‰å•†è«‡ã®é€²æ—ç®¡ç†ã€é¡§å®¢ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†ã¾ã§ä¸€å…ƒåŒ–ã—ã¾ã™ã€‚ã‚«ã‚¹ã‚¿ãƒ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦ç‹¬è‡ªã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’æ§‹ç¯‰ã—ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’è¨­å®šã—ã¦æ¥­å‹™ã®è‡ªå‹•åŒ–ã‚’å®Ÿç¾ã—ã¾ã™ã€‚Salesforce Einstein ã‚’æ´»ç”¨ã—ãŸäºˆæ¸¬åˆ†ææ©Ÿèƒ½ã«ã‚ˆã‚Šã€å–¶æ¥­ã®æˆç´„ç¢ºç‡ã‚„é¡§å®¢ã®ãƒãƒ£ãƒ¼ãƒ³äºˆæ¸¬ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚APIã‚’ä½¿ç”¨ã—ã¦ä»–ã‚·ã‚¹ãƒ†ãƒ ã¨ã®é€£æºã‚‚é‡è¦ã§ã™ã€‚'
        },
        {
            'title': 'Google Analytics 4ã¨Google Tag Managerè¨­å®š',
            'skill': 'Webã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹',
            'description': 'GA4ã®æ–°æ©Ÿèƒ½ã¨ GTM ã‚’ä½¿ç”¨ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆ ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã®å®Ÿè£…æ–¹æ³•',
            'summary': 'Google Analytics 4 ã¨ã‚¿ã‚°ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚’ä½¿ç”¨ã—ãŸã‚¦ã‚§ãƒ–è§£æã®å®Ÿè·µ',
            'transcript': 'Google Analytics 4ã§ã¯å¾“æ¥ã®ãƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆãƒ™ãƒ¼ã‚¹ã®è¨ˆæ¸¬ã«å¤‰æ›´ã•ã‚Œã¾ã—ãŸã€‚Google Tag Manager ã‚’ä½¿ç”¨ã—ã¦ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®šã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¡Œå‹•ã‚’è©³ç´°ã«è¿½è·¡ã—ã¾ã™ã€‚ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã®è¨­å®šã«ã‚ˆã‚Šã€ã‚´ãƒ¼ãƒ«é”æˆã®æ¸¬å®šãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚Enhanced Ecommerceæ©Ÿèƒ½ã§ã¯è³¼å…¥ãƒ•ã‚¡ãƒãƒ«ã®åˆ†æãŒã§ãã€ã‚«ã‚¹ã‚¿ãƒ ãƒ‡ã‚£ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã§ç‹¬è‡ªã®åˆ†æè»¸ã‚’è¿½åŠ ã§ãã¾ã™ã€‚BigQuery ã¨ã®é€£æºã«ã‚ˆã‚Šå¤§é‡ãƒ‡ãƒ¼ã‚¿ã®é«˜åº¦ãªåˆ†æã‚‚å®Ÿç¾ã—ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã‚¹ã‚¿ã‚¸ã‚ªã§ã®å¯è¦–åŒ–ã‚‚é‡è¦ãªè¦ç´ ã§ã™ã€‚'
        }
    ]

def create_sample_approved_candidates() -> List[str]:
    """ã‚µãƒ³ãƒ—ãƒ«ã®æ‰¿èªæ¸ˆã¿ã‚¿ã‚°å€™è£œã‚’ä½œæˆ"""
    return [
        # å…·ä½“çš„ãªãƒ„ãƒ¼ãƒ«ãƒ»ã‚µãƒ¼ãƒ“ã‚¹å
        'Google Analytics', 'Google Analytics 4', 'Google Tag Manager', 'BigQuery',
        'Salesforce', 'Salesforce CRM', 'Salesforce Einstein',
        'Facebookåºƒå‘Š', 'Instagramåºƒå‘Š', 'Excelé–¢æ•°', 'VLOOKUPé–¢æ•°',
        'SUMIFSé–¢æ•°', 'INDEXé–¢æ•°', 'MATCHé–¢æ•°', 'ãƒ”ãƒœãƒƒãƒˆãƒ†ãƒ¼ãƒ–ãƒ«', 'Power Query',
        
        # æ¸¬å®šå¯èƒ½ãªæŒ‡æ¨™ãƒ»KPI
        'ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç‡', 'LTV', 'ROIè¨ˆç®—', 'A/Bãƒ†ã‚¹ãƒˆ', 'ãƒãƒ£ãƒ¼ãƒ³äºˆæ¸¬',
        'æˆç´„ç¢ºç‡', 'ã‚«ã‚¹ã‚¿ãƒ ãƒ‡ã‚£ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³', 'Enhanced Ecommerce',
        
        # å…·ä½“çš„ãªæ‰‹æ³•ãƒ»ãƒ—ãƒ­ã‚»ã‚¹
        'SEOå¯¾ç­–', 'ãƒªãƒ†ãƒ³ã‚·ãƒ§ãƒ³æ–½ç­–', 'ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è¨­å®š', 'APIé€£æº',
        'ã‚¤ãƒ™ãƒ³ãƒˆãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°', 'ã‚«ã‚¹ã‚¿ãƒ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ', 'ãƒ‡ãƒ¼ã‚¿ã‚¹ã‚¿ã‚¸ã‚ªå¯è¦–åŒ–',
        
        # å°‚é–€çš„ãªæ¦‚å¿µï¼ˆä½†ã—å…·ä½“çš„ï¼‰
        'ã‚ªãƒ¼ã‚¬ãƒ‹ãƒƒã‚¯æ¤œç´¢', 'ãƒšã‚¤ãƒ‰ãƒ¡ãƒ‡ã‚£ã‚¢æˆ¦ç•¥', 'é¡§å®¢ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†',
        'ãƒªãƒ¼ãƒ‰ç®¡ç†', 'å•†è«‡é€²æ—ç®¡ç†', 'ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š',
        
        # æ±ç”¨çš„ã ãŒé¿ã‘ã‚‹ã¹ãã‚¿ã‚°ï¼ˆæ¯”è¼ƒç”¨ï¼‰
        'ãƒ“ã‚¸ãƒã‚¹ã‚¹ã‚­ãƒ«', 'ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°', 'ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³', 'ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³',
        'ãƒ‡ãƒ¼ã‚¿åˆ†æ', 'CRMç®¡ç†', 'Webã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹', 'å–¶æ¥­', 'åŠ¹ç‡åŒ–', 'æœ€é©åŒ–'
    ]

def print_test_results(results: Dict[str, Any]) -> None:
    """ãƒ†ã‚¹ãƒˆçµæœã‚’æ•´ç†ã—ã¦è¡¨ç¤º"""
    print(f"\n{'='*80}")
    print(f"æ”¹è‰¯ç‰ˆStage2ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ ãƒ†ã‚¹ãƒˆçµæœ")
    print(f"{'='*80}")
    
    if not results.get('success'):
        print(f"âŒ ãƒ†ã‚¹ãƒˆå¤±æ•—: {results.get('error', 'Unknown error')}")
        return
    
    test_results = results.get('results', [])
    statistics = results.get('statistics', {})
    
    print(f"ğŸ“Š çµ±è¨ˆæƒ…å ±:")
    print(f"  â€¢ å‡¦ç†å‹•ç”»æ•°: {statistics.get('total_videos', 0)}ä»¶")
    print(f"  â€¢ å¹³å‡ã‚¿ã‚°æ•°: {statistics.get('avg_tags_per_video', 0):.1f}å€‹/å‹•ç”»")
    print(f"  â€¢ ç·ã‚¿ã‚°æ•°: {statistics.get('total_tags_assigned', 0)}å€‹")
    print(f"  â€¢ å‡¦ç†æ™‚é–“: {statistics.get('processing_time', 0):.2f}ç§’")
    
    print(f"\nğŸ¯ å€‹åˆ¥å‹•ç”»çµæœ:")
    for i, result in enumerate(test_results):
        title = result.get('title', 'Unknown')[:40]
        tags = result.get('selected_tags', [])
        confidence = result.get('confidence', 0)
        
        print(f"\n  ã€å‹•ç”» {i+1}ã€‘ {title}")
        print(f"  ä¿¡é ¼åº¦: {confidence}")
        print(f"  ã‚¿ã‚°æ•°: {len(tags)}å€‹")
        print(f"  é¸å®šã‚¿ã‚°: {', '.join(tags[:8])}{'...' if len(tags) > 8 else ''}")
        
        # æ±ç”¨ã‚¿ã‚°ã‚’ãƒã‚§ãƒƒã‚¯
        generic_tags = ['ãƒ“ã‚¸ãƒã‚¹ã‚¹ã‚­ãƒ«', 'ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°', 'ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³', 
                       'ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³', 'ãƒ‡ãƒ¼ã‚¿åˆ†æ', 'CRMç®¡ç†', 'Webã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹']
        found_generic = [tag for tag in tags if tag in generic_tags]
        if found_generic:
            print(f"  âš ï¸ æ±ç”¨ã‚¿ã‚°æ¤œå‡º: {', '.join(found_generic)}")
        else:
            print(f"  âœ… æ±ç”¨ã‚¿ã‚°å›é¿æˆåŠŸ")

def main():
    """ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œé–¢æ•°"""
    print("æ”¹è‰¯ç‰ˆStage2ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å‹•ä½œãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã™...\n")
    
    # ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
    test_videos = create_test_video_data()
    approved_candidates = create_sample_approved_candidates()
    
    print(f"ãƒ†ã‚¹ãƒˆå¯¾è±¡:")
    print(f"  â€¢ å‹•ç”»ãƒ‡ãƒ¼ã‚¿: {len(test_videos)}ä»¶")
    print(f"  â€¢ æ‰¿èªæ¸ˆã¿ã‚¿ã‚°å€™è£œ: {len(approved_candidates)}å€‹")
    
    # AIãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã¨ãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼ã‚’åˆæœŸåŒ–
    try:
        ai_handler = AIAPIHandler()
        processor = StagedTagProcessor(ai_handler)
        
        # Stage2ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        print(f"\nğŸš€ Stage2å€‹åˆ¥ã‚¿ã‚°ä»˜ã‘ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­...")
        results = processor.execute_stage2_individual_tagging(
            test_videos, 
            approved_candidates, 
            ai_engine='claude'
        )
        
        # çµæœã‚’è¡¨ç¤º
        print_test_results(results)
        
        # çµæœã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
        output_file = 'stage2_test_results.json'
        with open(output_file, 'w', encoding='utf-8') as f:
            json.dump(results, f, ensure_ascii=False, indent=2)
        
        print(f"\nğŸ’¾ è©³ç´°çµæœã‚’ {output_file} ã«ä¿å­˜ã—ã¾ã—ãŸ")
        
    except Exception as e:
        print(f"âŒ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¨ãƒ©ãƒ¼: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    main()